name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    lint-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Check Prettier formatting
              run: npm run format:check

            - name: Run TypeScript type check
              run: npm run type-check

            - name: Run tests
              run: npm test

            - name: Generate test coverage
              run: npm run test:coverage

            - name: Upload coverage reports
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella

    build-and-deploy:
        runs-on: ubuntu-latest
        needs: lint-and-test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Deploy to Netlify
              if: github.ref == 'refs/heads/main'
              uses: nwtgck/actions-netlify@v3.0
              with:
                  publish-dir: './.next'
                  production-branch: main
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  deploy-message: 'Deploy from GitHub Actions'
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    security-scan:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run npm audit
              run: npm audit --audit-level moderate

            - name: Run security scan with CodeQL
              uses: github/codeql-action/init@v2
              with:
                  languages: javascript

            - name: Autobuild
              uses: github/codeql-action/autobuild@v2

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v2

    performance-test:
        runs-on: ubuntu-latest
        needs: build-and-deploy

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Install Lighthouse CI
              run: npm install -g @lhci/cli

            - name: Build application
              run: npm run build

            - name: Start application
              run: npm start &
              env:
                  NODE_ENV: production

            - name: Wait for server
              run: sleep 30

            - name: Run Lighthouse CI
              run: lhci autorun
              env:
                  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    notify:
        runs-on: ubuntu-latest
        needs: [lint-and-test, build-and-deploy, security-scan]
        if: always()

        steps:
            - name: Notify success
              if: needs.lint-and-test.result == 'success' && needs.build-and-deploy.result == 'success' && needs.security-scan.result == 'success'
              uses: 8398a7/action-slack@v3
              with:
                  status: success
                  text: 'üéâ Build successful! All tests passed.'
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Notify failure
              if: failure()
              uses: 8398a7/action-slack@v3
              with:
                  status: failure
                  text: '‚ùå Build failed! Check the logs for details.'
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
